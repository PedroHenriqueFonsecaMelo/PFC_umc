<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Minha Conta - Atualiza√ß√£o de Dados</title>
        <style>
        /* Base */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        h1 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }
        /* Formul√°rio e Fieldset */
        fieldset { margin-bottom: 25px; padding: 25px; border: 1px solid #ddd; border-radius: 10px; background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        legend { font-weight: bold; padding: 0 10px; font-size: 1.3em; color: #007bff; margin-left: -10px; }
        /* Layout de Campos */
        .form-row { display: flex; flex-wrap: wrap; gap: 20px; }
        .form-group { flex: 1 1 45%; min-width: 300px; }
        label { display: block; margin-top: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="email"], input[type="date"], input[type="password"], select { 
            width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; 
        }
        /* Itens Din√¢micos (Endere√ßos/Cart√µes) */
        .item-list-container { display: flex; flex-direction: column; gap: 15px; }
        .cartao-item, .endereco-item { border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background-color: #f9f9f9; }
        .novo-item { border: 2px dashed #ffc107; background-color: #fffde7; }
        /* Bot√µes */
        .action-button { 
            padding: 10px 18px; 
            cursor: pointer; 
            border-radius: 6px; 
            border: none; 
            font-weight: bold; 
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        .btn-principal { background-color: #007bff; color: white; }
        .btn-principal:hover { background-color: #0056b3; }
        .btn-remover { background-color: #dc3545; color: white; margin-left: 10px; }
        .btn-remover:hover { background-color: #c82333; }
        /* Mensagens */
        .mensagem { padding: 15px; margin-bottom: 20px; border-radius: 6px; font-weight: bold; }
        .sucesso { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .erro { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        /* Leitura */
        .readonly-field { background-color: #eeeeee; font-weight: normal; }
    </style>
    </head>
    <body>
        <h1>Minha Conta - Detalhes üë§</h1>
        <div>
            <p>Bem-vindo(a), <strong th:text="${cliente.nome}">Teste
                    Usuario</strong>! Aqui voc√™ pode atualizar suas informa√ß√µes
                e associa√ß√µes.</p>

            <form th:action="@{/clientes/atualizar}" th:object="${cliente}"
                method="post" id="updateForm" name="updateForm">
                <input type="hidden" id="id" name="id" th:field="*{id}" />

                <fieldset>
                    <legend>Dados Pessoais</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome">Nome:</label> <input type="text"
                                id="nome" required th:field="*{nome}" />
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label> <input
                                type="email" id="email" readonly
                                class="readonly-field"
                                title="Email n√£o pode ser alterado diretamente."
                                th:field="*{email}" />
                        </div>
                        <div class="form-group">
                            <label for="cpf">CPF:</label> <input type="text"
                                id="cpf" readonly class="readonly-field"
                                th:field="*{cpf}" />
                        </div>
                        <div class="form-group">
                            <label for="datanasc">Data de Nascimento:</label>
                            <input type="date" id="datanasc" required
                                th:field="*{datanasc}" />
                        </div>
                        <div class="form-group">
                            <label for="gen">G√™nero:</label>
                            <select id="gen" th:field="*{gen}">
                                <option value="">Selecione</option>
                                <option value="M">M - Masculino</option>
                                <option value="F">F - Feminino</option>
                                <option value="OUTRO">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="senha">Nova Senha:</label>
                            <input type="password" id="senha"
                                placeholder="Deixe em branco para manter a senha atual"
                                autocomplete="new-password" name="senha"
                                value />
                        </div>
                    </div>
                </fieldset>

                <hr>

                <h2>Endere√ßos Cadastrados üè†</h2>
                <div id="enderecos-list-container" class="item-list-container">
                    <div class="endereco-item"
                        th:each="endereco, stat : *{enderecos}"
                        th:with="idx=${stat.index}">
                        <fieldset>
                            <legend
                                th:text="|Endere√ßo ${stat.count} (ID: ${endereco.id})|">Endere√ßo
                                1</legend>
                            <input type="hidden"
                                th:name="|enderecos[${idx}].id|"
                                th:value="${endereco.id}" />
                            <div class="form-row">
                                <div
                                    class="form-group"><label>CEP:</label><input
                                        type="text"
                                        th:name="|enderecos[${idx}].cep|"
                                        th:value="${endereco.cep}"
                                        required /></div>
                                <div
                                    class="form-group"><label>Rua:</label><input
                                        type="text"
                                        th:name="|enderecos[${idx}].rua|"
                                        th:value="${endereco.rua}"
                                        required /></div>
                                <div
                                    class="form-group"><label>N√∫mero:</label><input
                                        type="text"
                                        th:name="|enderecos[${idx}].numero|"
                                        th:value="${endereco.numero}"
                                        required /></div>
                                <div
                                    class="form-group"><label>Complemento:</label><input
                                        type="text"
                                        th:name="|enderecos[${idx}].complemento|"
                                        th:value="${endereco.complemento}" /></div>
                                <div
                                    class="form-group"><label>Bairro:</label><input
                                        type="text"
                                        th:name="|enderecos[${idx}].bairro|"
                                        th:value="${endereco.bairro}"
                                        required /></div>
                                <div
                                    class="form-group"><label>Cidade:</label><input
                                        type="text"
                                        th:name="|enderecos[${idx}].cidade|"
                                        th:value="${endereco.cidade}"
                                        required /></div>
                                <div
                                    class="form-group"><label>Estado:</label><input
                                        type="text"
                                        th:name="|enderecos[${idx}].estado|"
                                        th:value="${endereco.estado}"
                                        required /></div>
                                <div
                                    class="form-group"><label>Pa√≠s:</label><input
                                        type="text"
                                        th:name="|enderecos[${idx}].pais|"
                                        th:value="${endereco.pais}"
                                        required /></div>
                                <div class="form-group"><label>Tipo de
                                        resid√™ncia:</label><input type="text"
                                        th:name="|enderecos[${idx}].tipoResidencia|"
                                        th:value="${endereco.tipoResidencia}"
                                        required /></div>
                            </div>

                            <button type="submit"
                                class="action-button btn-remover"
                                onclick="return confirm('Tem certeza que deseja remover este endere√ßo? Esta a√ß√£o √© imediata.');"
                                th:form="|removeEnderecoForm_${endereco.id}|">
                                üè† Remover este Endere√ßo
                            </button>
                        </fieldset>
                    </div>
                </div>

                <button type="button" onclick="adicionarEndereco()"
                    class="action-button btn-principal">‚ûï Adicionar Novo
                    Endere√ßo</button>

                <hr>

                <h2>Cart√µes Cadastrados üí≥</h2>
                <div id="cartoes-list-container" class="item-list-container">
                    <div class="cartao-item" th:each="cartao, stat : *{cartoes}"
                        th:with="idx=${stat.index}">
                        <fieldset>
                            <legend
                                th:text="|Cart√£o ${stat.count} (ID: ${cartao.id})|">Cart√£o
                                1</legend>
                            <input type="hidden" th:name="|cartoes[${idx}].id|"
                                th:value="${cartao.id}" />
                            <div class="form-row">
                                <div class="form-group">
                                    <label>N√∫mero do Cart√£o:</label>
                                    <input type="text" readonly
                                        class="readonly-field"
                                        th:value="|**** **** **** ${cartao.numero}|" />
                                </div>
                                <div class="form-group">
                                    <label>Nome no Cart√£o:</label>
                                    <input type="text" required
                                        th:name="|cartoes[${idx}].nomeTitular|"
                                        th:value="${cartao.nomeTitular}" />
                                </div>
                                <div class="form-group">
                                    <label>Validade:</label>
                                    <input type="text" readonly
                                        class="readonly-field"
                                        th:name="|cartoes[${idx}].validade|"
                                        th:value="${cartao.validade}" />
                                </div>
                                <div class="form-group">
                                    <label>CPF do Titular:</label>
                                    <input type="text" readonly
                                        class="readonly-field"
                                        th:name="|cartoes[${idx}].cpfTitular|"
                                        th:value="${cartao.cpfTitular}" />
                                </div>
                                <div class="form-group">
                                    <label>Bandeira:</label>
                                    <input type="text" readonly
                                        class="readonly-field"
                                        th:name="|cartoes[${idx}].bandeira|"
                                        th:value="${cartao.bandeira}" />
                                </div>
                            </div>

                            <button type="submit"
                                class="action-button btn-remover"
                                onclick="return confirm('Tem certeza que deseja remover este cart√£o? Esta a√ß√£o √© imediata.');"
                                th:form="|removeCardForm_${cartao.id}|">
                                üí≥ Remover este Cart√£o
                            </button>
                        </fieldset>
                    </div>
                </div>

                <button type="button" onclick="adicionarCartao()"
                    class="action-button btn-principal">‚ûï Adicionar Novo
                    Cart√£o</button>

                <hr>

                <button type="submit" class="action-button btn-principal">üíæ
                    Atualizar Informa√ß√µes</button>
            </form>

            <hr>

            <div th:each="endereco : ${cliente.enderecos}"
                style="display:none;">
                <form th:id="|removeEnderecoForm_${endereco.id}|"
                    th:action="@{/clientes/removerEndereco}" method="post">
                    <input type="hidden" name="enderecoId"
                        th:value="${endereco.id}" />

                </form>
            </div>

            <div th:each="cartao : ${cliente.cartoes}" style="display:none;">
                <form th:id="|removeCardForm_${cartao.id}|"
                    th:action="@{/clientes/removerCartao}" method="post">
                    <input type="hidden" name="cartaoId"
                        th:value="${cartao.id}" />
                </form>
            </div>

            <p><a th:href="@{/clientes/logout}" class="link-acao">Sair da
                    Conta</a></p>

            <form th:action="@{/clientes/deletar}" method="post"
                style="display:inline-block; margin-top: 10px;">
                <button type="submit" class="action-button btn-remover"
                    onclick="return confirm('AVISO CR√çTICO: Voc√™ est√° prestes a DELETAR PERMANENTEMENTE sua conta. Tem certeza absoluta?');">‚õî
                    Deletar Minha Conta</button>
            </form>
        </div>

        <script th:inline="javascript">
        // Os √≠ndices s√£o inicializados com o tamanho das listas existentes
        let enderecoIndex = [[${cliente.enderecos != null ? cliente.enderecos.size() : 0}]];
        let cartaoIndex = [[${cliente.cartoes != null ? cliente.cartoes.size() : 0}]];
        
        // === FUN√á√ÉO ENDERE√áO ===
        function adicionarEndereco() {
            const container = document.getElementById("enderecos-list-container");
            const idx = enderecoIndex++; 

            const html = `
            <div class="endereco-item novo-item">
                <fieldset>
                    <legend>Novo Endere√ßo (tempor√°rio)</legend>
                    <input type="hidden" name="enderecos[${idx}].id" value="" /> 
                    <div class="form-row">
                        <div class="form-group"><label>CEP:</label><input type="text" name="enderecos[${idx}].cep" required></div>
                        <div class="form-group"><label>Rua:</label><input type="text" name="enderecos[${idx}].rua" required></div>
                        <div class="form-group"><label>N√∫mero:</label><input type="text" name="enderecos[${idx}].numero" required></div>
                        <div class="form-group"><label>Complemento:</label><input type="text" name="enderecos[${idx}].complemento"></div>
                        <div class="form-group"><label>Bairro:</label><input type="text" name="enderecos[${idx}].bairro" required></div>
                        <div class="form-group"><label>Cidade:</label><input type="text" name="enderecos[${idx}].cidade" required></div>
                        <div class="form-group"><label>Estado:</label><input type="text" name="enderecos[${idx}].estado" required></div>
                        <div class="form-group"><label>Pa√≠s:</label><input type="text" name="enderecos[${idx}].pais" required></div>
                        <div class="form-group"><label>Tipo de resid√™ncia:</label><input type="text" name="enderecos[${idx}].tipoResidencia" required></div>
                    </div>
                    <button type="button" onclick="this.closest('.endereco-item').remove()" class="action-button btn-remover">üóëÔ∏è Remover Novo Endere√ßo</button>
                </fieldset>
            </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // === FUN√á√ÉO CART√ÉO ===
        function adicionarCartao() {
            const container = document.getElementById("cartoes-list-container");
            const idx = cartaoIndex++; 

            const html = `
            <div class="cartao-item novo-item">
                <fieldset>
                    <legend>Novo Cart√£o (tempor√°rio)</legend>
                    <input type="hidden" name="cartoes[${idx}].id" value="" /> 
                    <div class="form-row">
                        <div class="form-group"><label>N√∫mero do Cart√£o:</label><input type="text" name="cartoes[${idx}].numero" required placeholder="Apenas n√∫meros, sem espa√ßos"></div>
                        <div class="form-group"><label>Nome no Cart√£o:</label><input type="text" name="cartoes[${idx}].nomeTitular" required></div>
                        <div class="form-group"><label>CPF do Titular:</label><input type="text" name="cartoes[${idx}].cpfTitular" required></div>
                        <div class="form-group"><label>Validade:</label><input type="text" name="cartoes[${idx}].validade" placeholder="MM/AAAA" required></div>
                        <div class="form-group"><label>Bandeira:</label><input type="text" name="cartoes[${idx}].bandeira" placeholder="Ex: VISA, MASTER" required></div>
                    </div>
                    
                    <button type="button" 
                        onclick="this.closest('.cartao-item').remove()" 
                        class="action-button btn-remover">
                        üóëÔ∏è Remover Novo Cart√£o
                    </button>
                </fieldset>
            </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
    </script>
    </body>
</html>